on:
  push:
    branches:
      - main
  pull_request:
name: ci
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [16, 18, 20]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
      - run: node --version
      # The first installation step ensures that all of our production
      # dependencies work on the given Node.js version, this helps us find
      # dependencies that don't match our engines field:
      - run: npm install --production --engine-strict --ignore-scripts --no-package-lock
      # Clean up the production install, before installing dev/production:
      - run: rm -rf node_modules
      - run: npm install
      - run: npm test
  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
    steps:
      - uses: actions/checkout@v3
      # Now that we know the build runs, create a release PR if needed.
      - uses: release-please-plus/action@main
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # command: manifest
          bootstrap-sha: a19f46b3700491390092966ba14fd5fdd15a8b69
          release-type: node
          plugins: sentence-case
          changelog-types: >
            [
              { "type": "feat", "section": "âœ¨ Features" },
              { "type": "feature", "section": "âœ¨ Features" },
              { "type": "perf", "section": "âš¡ï¸Performance Improvements" },
              { "type": "fix", "section": "ğŸ› Bug Fixes" },
              { "type": "revert", "section": "âªï¸ Reverts" },
              { "type": "docs", "section": "ğŸ“ Documentation" },
              { "type": "style", "section": "ğŸ¨ Styles" },
              { "type": "chore", "section": "ğŸ¡ Miscellaneous Chores" },
              { "type": "refactor", "section": "â™»ï¸ Code Refactoring", "hidden": true },
              { "type": "test", "section": "âœ… Tests", "hidden": true },
              { "type": "build", "section": "ğŸ“¦ï¸ Build System", "hidden": true },
              { "type": "ci", "section": "ğŸ¤– Continuous Integration", "hidden": true }
            ]
          extra-files: |
            { "type": "xml", "path": "src/Test.csproj", "xpath": "//project/propertygroup/version" }
            { "type": "xml", "path": "src/Directory.Build.props", "xpath": "//project/propertygroup/version" }
      - name: Update semver tags # useful for actions
        if: ${{ steps.release.outputs.releases_created }}
        uses: sersoft-gmbh/running-release-tags-action@v2.1.2
        with:
          tag: ${{ steps.release.outputs.tag_name }}
          update-minor: false
